---
title: "An√°lisis estatuto de Urrao"
format: 
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    theme: cosmo
    smooth-scroll: true
execute:
  echo: false
  warning: false
  message: false
params:
  cod_dane: "05847"
  nombre: "Urrao"
lang: es
---


Este proyecto presenta un an√°lisis exhaustivo de los estatutos tributarios del municipio de 
Para el an√°lisis del municipio de , enfoc√°ndose espec√≠ficamente en la estructura del impuesto predial. El estatuto fue acompa√±ado de un an√°lisis jur√≠dico y de contenido detallado del cap√≠tulo de impuestos prediales contenido en sus estatutos de rentas.

Para el an√°lisis del municipio se tuvieron  en cuenta los siguientes estatutos y modificaciones:

```{r}
#| echo: false
#| message: false
#| warning: false

# Funci√≥n para leer archivos RDS con rutas relativas
lee_rds <- function(rel){
  candidatos <- c(rel, file.path('..', rel), file.path('..','..', rel))
  existente <- candidatos[file.exists(candidatos)][1]
  if(is.na(existente)) stop('No se encontr√≥ ', rel, ' en rutas: ', paste(candidatos, collapse=', '))
  readRDS(existente)
}

# Cargar librer√≠as necesarias
library(dplyr)
library(knitr)
library(ggplot2)
library(scales)
suppressPackageStartupMessages({
  library(gridExtra, quietly = TRUE)
  library(grid, quietly = TRUE)
  library(tidyr, quietly = TRUE)
})

# Configurar opciones de gr√°ficos
options(scipen = 999)  # Evitar notaci√≥n cient√≠fica

# Cargar datos completos con manejo de ausencia del archivo
datos_disponibles <- TRUE
bd_estatutos <- NULL
tryCatch({
  bd_estatutos <- lee_rds("ds_estatutos/BD_Estatutos.rds")
}, error = function(e){
  datos_disponibles <<- FALSE
  mensaje <- paste0("‚ö†Ô∏è No se encontr√≥ el dataset 'BD_Estatutos.rds'. Se mostrar√° una versi√≥n reducida del informe. Detalle: ", e$message)
  message(mensaje)
  cat(mensaje, "\n\n")
})

# Filtrar para el municipio espec√≠fico (si hay datos)
if (datos_disponibles) {
  datos_municipio <- bd_estatutos %>% filter(codigo_dane == params$cod_dane)
} else {
  datos_municipio <- data.frame()
}

# Tabla de estatutos
freq_cat <- datos_municipio %>%
  mutate(
    filename = if ('filename' %in% names(cur_data_all())) filename else NA_character_,
    enlace_pdf = if_else(!is.na(filename) & filename != "", 
                         paste0("[Descargar PDF](pdfs/", filename, ")"), 
                         "No disponible")
  ) %>%
  select(any_of(c("mpio","anio","tipo","numero","observaciones","enlace_pdf")))

if (nrow(freq_cat) == 0) {
  cat("No hay estatutos registrados para este municipio.\n")
} else {
  knitr::kable(head(freq_cat, 200), caption = "Estatutos Usados para el Estudio", escape = FALSE)
}
```


Para ver m√°s an√°lisis agregados y los detalles metodol√≥gicos puede visitar este enlace [(ir)](https://jcmunozmora.github.io/estatutos_analisis/).

# Estad√≠sticas del municipio

```{r}
#| echo: false
#| message: false
#| warning: false

if (nrow(datos_municipio) > 0) {
  # Estad√≠sticas b√°sicas
  cat("## Resumen estad√≠stico\n\n")
  cat("- **Total de registros analizados:** ", nrow(datos_municipio), "\n")
  
  if ("anio" %in% names(datos_municipio)) {
    anos_unicos <- sort(unique(datos_municipio$anio[!is.na(datos_municipio$anio)]))
    if (length(anos_unicos) > 0) {
      cat("- **Per√≠odo analizado:** ", min(anos_unicos), " - ", max(anos_unicos), "\n")
      cat("- **A√±os con estatutos:** ", paste(anos_unicos, collapse = ", "), "\n")
    }
  }
  
  if ("tipo" %in% names(datos_municipio)) {
    tipos_unicos <- unique(datos_municipio$tipo[!is.na(datos_municipio$tipo)])
    if (length(tipos_unicos) > 0) {
      cat("- **Tipos de normativa:** ", paste(tipos_unicos, collapse = ", "), "\n")
    }
  }
  
  # Comparaci√≥n con el departamento
  total_departamento <- nrow(bd_estatutos)
  porcentaje <- round((nrow(datos_municipio) / total_departamento) * 100, 2)
  cat("- **Representaci√≥n en el estudio:** ", porcentaje, "% del total departamental\n")
  
} else {
  cat("No hay datos disponibles para generar estad√≠sticas.\n")
}
```

# An√°lisis de estructura tarifaria

## Combinaciones de criterios tarifarios

```{r}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Verificar si existe la imagen de combinaciones para este municipio
img_combos <- paste0("img_estatutos/", params$cod_dane, "_combos.png")

if (file.exists(img_combos)) {
  cat("Este gr√°fico muestra las diferentes combinaciones de criterios utilizados en la estructura tarifaria del municipio:\n\n")
  cat("![Combinaciones de criterios tarifarios](", img_combos, "){width=90%}\n\n")
  cat("**Descripci√≥n:** Visualizaci√≥n de las combinaciones de criterios (aval√∫o, √°rea, destino, estrato, etc.) utilizadas para determinar las tarifas prediales en ", params$nombre, ".\n\n")
  cat("**Interpretaci√≥n:** Cada combinaci√≥n representa una regla espec√≠fica del estatuto tributario. Mayor n√∫mero de combinaciones indica mayor complejidad normativa.\n\n")
} else {
  # Generar an√°lisis din√°mico desde los datos
  cat("### An√°lisis de criterios tarifarios (generado din√°micamente)\n\n")
  
  tryCatch({
    bd_transcripciones <- lee_rds("ds_estatutos/BD_Transcripciones.rds")
    
    # Filtrar datos del municipio
    datos_criterios <- bd_transcripciones %>%
      filter(codigo_dane == params$cod_dane)
    
    if (nrow(datos_criterios) > 0) {
      library(ggplot2)
      library(dplyr)
      
      # Analizar qu√© criterios se utilizan
      criterios_utilizados <- datos_criterios %>%
        summarise(
          usa_avaluo = any(!is.na(avaluo_desde) | !is.na(avaluo_hasta)),
          usa_area = any(!is.na(area_desde) | !is.na(area_hasta)),
          usa_destino = any(!is.na(destino) & destino != ""),
          usa_estrato = any(!is.na(estrato) & estrato != ""),
          usa_zona = any(!is.na(zona) & zona != "")
        )
      
      # Crear resumen de criterios
      criterios_activos <- c()
      if (criterios_utilizados$usa_avaluo) criterios_activos <- c(criterios_activos, "Aval√∫o")
      if (criterios_utilizados$usa_area) criterios_activos <- c(criterios_activos, "√Årea")
      if (criterios_utilizados$usa_destino) criterios_activos <- c(criterios_activos, "Destino")
      if (criterios_utilizados$usa_estrato) criterios_activos <- c(criterios_activos, "Estrato")
      if (criterios_utilizados$usa_zona) criterios_activos <- c(criterios_activos, "Zona")
      
      cat("**Criterios tarifarios identificados:**\n")
      if (length(criterios_activos) > 0) {
        for (criterio in criterios_activos) {
          cat("- ‚úì ", criterio, "\n")
        }
      } else {
        cat("- No se identificaron criterios espec√≠ficos en los datos disponibles\n")
      }
      cat("\n")
      
      # An√°lisis de combinaciones m√°s frecuentes
      if (length(criterios_activos) > 1) {
        # Crear combinaciones de criterios
        combinaciones <- datos_criterios %>%
          mutate(
            combinacion = paste(
              ifelse(!is.na(avaluo_desde) | !is.na(avaluo_hasta), "Aval√∫o", ""),
              ifelse(!is.na(area_desde) | !is.na(area_hasta), "√Årea", ""),
              ifelse(!is.na(destino) & destino != "", "Destino", ""),
              ifelse(!is.na(estrato) & estrato != "", "Estrato", ""),
              ifelse(!is.na(zona) & zona != "", "Zona", ""),
              sep = "+"
            )
          ) %>%
          mutate(combinacion = gsub("\\+{2,}", "+", combinacion)) %>%
          mutate(combinacion = gsub("^\\+|\\+$", "", combinacion)) %>%
          filter(combinacion != "") %>%
          count(combinacion, sort = TRUE)
        
        if (nrow(combinaciones) > 0) {
          cat("**Combinaciones de criterios m√°s frecuentes:**\n")
          for (i in 1:min(5, nrow(combinaciones))) {
            cat("- ", combinaciones$combinacion[i], ": ", combinaciones$n[i], " reglas\n")
          }
          cat("\n")
          
          # Gr√°fico de barras de combinaciones
          if (nrow(combinaciones) > 1) {
            p_combos <- ggplot(head(combinaciones, 10), aes(x = reorder(combinacion, n), y = n)) +
              geom_col(fill = "steelblue", alpha = 0.8) +
              coord_flip() +
              labs(
                title = paste("Combinaciones de criterios tarifarios -", params$nombre),
                subtitle = "Top 10 combinaciones m√°s utilizadas",
                x = "Combinaci√≥n de criterios",
                y = "N√∫mero de reglas",
                caption = "Fuente: An√°lisis de estatutos tributarios"
              ) +
              theme_minimal() +
              theme(
                plot.title = element_text(size = 14, face = "bold"),
                plot.subtitle = element_text(size = 12),
                axis.title = element_text(size = 11)
              )
            
            print(p_combos)
          }
        }
      }
      
      # Estad√≠sticas de complejidad
      cat("\n**An√°lisis de complejidad normativa:**\n")
      cat("- **Total de reglas analizadas:** ", nrow(datos_criterios), "\n")
      cat("- **N√∫mero de criterios utilizados:** ", length(criterios_activos), "\n")
      
      if (length(criterios_activos) >= 3) {
        cat("- **Clasificaci√≥n:** Sistema de alta complejidad (m√∫ltiples criterios)\n")
      } else if (length(criterios_activos) == 2) {
        cat("- **Clasificaci√≥n:** Sistema de complejidad moderada\n")
      } else {
        cat("- **Clasificaci√≥n:** Sistema de baja complejidad (criterio √∫nico o simple)\n")
      }
      
    } else {
      cat("No se encontraron datos de criterios tarifarios para este municipio.\n")
    }
    
  }, error = function(e) {
    cat("*No fue posible generar el an√°lisis de criterios tarifarios para este municipio.*\n")
    cat("*Motivo: Datos de transcripci√≥n no disponibles o incompletos.*\n")
  })
}
```

## Distribuci√≥n de tarifas

```{r}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Verificar si existe la imagen de distribuci√≥n de tarifas
img_tarifas <- paste0("img_estatutos/", params$cod_dane, "_dist_tarifas.png")

if (file.exists(img_tarifas)) {
  cat("La distribuci√≥n de tarifas muestra el rango y frecuencia de las diferentes tarifas prediales establecidas:\n\n")
  cat("![Distribuci√≥n de tarifas prediales](", img_tarifas, "){width=90%}\n\n")
  cat("**Descripci√≥n:** Histograma que muestra la distribuci√≥n de las tarifas prediales por mil (‚Ä∞) establecidas en el estatuto de ", params$nombre, ".\n\n")
  cat("**Interpretaci√≥n:** La forma de la distribuci√≥n indica si el municipio tiende hacia tarifas uniformes (distribuci√≥n concentrada) o hacia un esquema m√°s diversificado (distribuci√≥n dispersa).\n\n")
} else {
  # Generar gr√°fico din√°mico desde los datos
  cat("### Distribuci√≥n de tarifas prediales (generado din√°micamente)\n\n")
  
  tryCatch({
    bd_transcripciones <- lee_rds("ds_estatutos/BD_Transcripciones.rds")
    
    # Filtrar datos del municipio
    datos_tarifas <- bd_transcripciones %>%
      filter(codigo_dane == params$cod_dane) %>%
      filter(!is.na(tarifa), tarifa > 0)
    
    if (nrow(datos_tarifas) > 0) {
      library(ggplot2)
      
      # Crear histograma de distribuci√≥n de tarifas mejorado
      p_dist <- ggplot(datos_tarifas, aes(x = tarifa)) +
        geom_histogram(aes(y = after_stat(density)), 
                       bins = min(30, max(5, nrow(datos_tarifas)/3)), 
                       fill = "lightblue", color = "darkblue", alpha = 0.7, size = 0.3) +
        geom_density(alpha = 0.3, fill = "blue", color = "blue", size = 1) +
        geom_vline(aes(xintercept = median(tarifa)), 
                   color = "red", linetype = "dashed", size = 1.2) +
        geom_vline(aes(xintercept = mean(tarifa)), 
                   color = "orange", linetype = "dashed", size = 1.2) +
        geom_vline(aes(xintercept = quantile(tarifa, 0.25)), 
                   color = "purple", linetype = "dotted", size = 0.8, alpha = 0.7) +
        geom_vline(aes(xintercept = quantile(tarifa, 0.75)), 
                   color = "purple", linetype = "dotted", size = 0.8, alpha = 0.7) +
        scale_x_continuous(
          labels = scales::number_format(suffix = "‚Ä∞"),
          name = "Tarifa predial (por mil)"
        ) +
        scale_y_continuous(
          name = "Densidad de probabilidad",
          labels = scales::number_format(accuracy = 0.01)
        ) +
        labs(
          title = paste("Distribuci√≥n de tarifas prediales -", params$nombre),
          subtitle = "üî¥ Mediana | üü† Promedio | üü£ Cuartiles (P25, P75) | üîµ Curva de densidad",
          caption = "An√°lisis de concentraci√≥n y dispersi√≥n tarifaria"
        ) +
        theme_minimal() +
        theme(
          plot.title = element_text(size = 14, face = "bold", color = "darkblue"),
          plot.subtitle = element_text(size = 10, color = "gray40"),
          plot.caption = element_text(size = 9, color = "gray50"),
          axis.title = element_text(size = 11),
          panel.grid.minor = element_blank(),
          panel.grid.major = element_line(color = "gray90", size = 0.5)
        )
      
      print(p_dist)
      
      # Estad√≠sticas descriptivas mejoradas
      tarifas_unicas <- unique(datos_tarifas$tarifa)
      rango_tarifas <- max(datos_tarifas$tarifa) - min(datos_tarifas$tarifa)
      q10 <- quantile(datos_tarifas$tarifa, 0.1)
      q90 <- quantile(datos_tarifas$tarifa, 0.9)
      asimetria <- round((mean(datos_tarifas$tarifa) - median(datos_tarifas$tarifa)) / sd(datos_tarifas$tarifa), 3)
      
      cat("\n**Estad√≠sticas descriptivas detalladas:**\n")
      cat("- **N√∫mero total de tarifas diferentes:** ", length(tarifas_unicas), "\n")
      cat("- **Rango de tarifas:** ", min(datos_tarifas$tarifa), "‚Ä∞ - ", max(datos_tarifas$tarifa), "‚Ä∞ (amplitud: ", round(rango_tarifas, 2), "‚Ä∞)\n")
      cat("- **Medidas de tendencia central:**\n")
      cat("  - Promedio: ", round(mean(datos_tarifas$tarifa), 2), "‚Ä∞\n")
      cat("  - Mediana: ", round(median(datos_tarifas$tarifa), 2), "‚Ä∞\n")
      cat("  - Moda: ", round(as.numeric(names(sort(table(datos_tarifas$tarifa), decreasing = TRUE))[1]), 2), "‚Ä∞\n")
      cat("- **Medidas de dispersi√≥n:**\n")
      cat("  - Desviaci√≥n est√°ndar: ", round(sd(datos_tarifas$tarifa), 2), "‚Ä∞\n")
      cat("  - Coeficiente de variaci√≥n: ", round(sd(datos_tarifas$tarifa)/mean(datos_tarifas$tarifa), 3), "\n")
      cat("  - Rango intercuart√≠lico (P25-P75): ", round(quantile(datos_tarifas$tarifa, 0.75) - quantile(datos_tarifas$tarifa, 0.25), 2), "‚Ä∞\n")
      cat("- **Percentiles clave:**\n")
      cat("  - P10: ", round(q10, 2), "‚Ä∞ | P90: ", round(q90, 2), "‚Ä∞\n")
      cat("- **Forma de la distribuci√≥n:**\n")
      cat("  - Asimetr√≠a: ", asimetria, if(asimetria > 0.5) " (sesgada hacia la derecha)" else if(asimetria < -0.5) " (sesgada hacia la izquierda)" else " (aproximadamente sim√©trica)", "\n")
      
      # An√°lisis de dispersi√≥n con interpretaci√≥n contextual
      cv <- sd(datos_tarifas$tarifa)/mean(datos_tarifas$tarifa)
      
      cat("\n**üìä An√°lisis de concentraci√≥n tarifaria:**\n")
      if (cv < 0.15) {
        cat("- **Tipo de sistema:** UNIFORME - Las tarifas est√°n muy concentradas\n")
        cat("- **Ventajas:** Simplicidad administrativa, f√°cil comprensi√≥n ciudadana\n")
        cat("- **Consideraciones:** Evaluar si captura diferencias en capacidad contributiva\n")
      } else if (cv < 0.30) {
        cat("- **Tipo de sistema:** MODERADAMENTE UNIFORME - Concentraci√≥n con cierta variabilidad\n")
        cat("- **Ventajas:** Balance entre simplicidad y diferenciaci√≥n\n")
        cat("- **Consideraciones:** Sistema equilibrado para contextos urbanos/rurales mixtos\n")
      } else if (cv < 0.70) {
        cat("- **Tipo de sistema:** DIVERSIFICADO - Amplio rango de tarifas\n")
        cat("- **Ventajas:** Mayor precisi√≥n en la diferenciaci√≥n contributiva\n")
        cat("- **Consideraciones:** Requiere mayor capacidad t√©cnica para aplicaci√≥n\n")
      } else {
        cat("- **Tipo de sistema:** ALTAMENTE DIVERSIFICADO - Muy amplio espectro tarifario\n")
        cat("- **Ventajas:** M√°xima precisi√≥n en diferenciaci√≥n\n")
        cat("- **Consideraciones:** Alta complejidad administrativa, revisar coherencia\n")
      }
      
      # An√°lisis de percentiles con interpretaci√≥n
      q25 <- quantile(datos_tarifas$tarifa, 0.25)
      q75 <- quantile(datos_tarifas$tarifa, 0.75)
      riq <- q75 - q25
      cat("- **Rango central (P25-P75):** ", round(q25, 2), "‚Ä∞ - ", round(q75, 2), "‚Ä∞ (RIQ: ", round(riq, 2), "‚Ä∞)\n")
      cat("- **Concentraci√≥n central:** ", round((riq / median(datos_tarifas$tarifa)) * 100, 1), "% de la mediana\n")
      
      # Detecci√≥n de outliers
      limite_inferior <- q25 - 1.5 * riq
      limite_superior <- q75 + 1.5 * riq
      outliers <- datos_tarifas$tarifa[datos_tarifas$tarifa < limite_inferior | datos_tarifas$tarifa > limite_superior]
      
      if (length(outliers) > 0) {
        cat("- **‚ö†Ô∏è Valores at√≠picos detectados:** ", length(outliers), " tarifas fuera del rango normal\n")
        cat("  - Tarifas extremas: ", paste(round(sort(outliers), 2), collapse = "‚Ä∞, "), "‚Ä∞\n")
        cat("  - **Recomendaci√≥n:** Revisar coherencia de estas tarifas excepcionales\n")
      } else {
        cat("- **‚úÖ Sin valores at√≠picos:** Todas las tarifas est√°n dentro del rango esperado\n")
      }
      
    } else {
      cat("No se encontraron datos de tarifas para este municipio.\n")
    }
    
  }, error = function(e) {
    cat("*No fue posible generar la distribuci√≥n de tarifas para este municipio.*\n")
    cat("*Motivo: Datos de transcripci√≥n no disponibles o incompletos.*\n")
  })
}
```

# An√°lisis de progresividad

## Progresividad por aval√∫o

```{r}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Verificar si existe la imagen ladder de aval√∫o
img_avaluo <- paste0("img_estatutos/", params$cod_dane, "_ladder_avaluo.png")

if (file.exists(img_avaluo)) {
  cat("El an√°lisis de progresividad por aval√∫o eval√∫a si las tarifas aumentan proporcionalmente con el valor del predio:\n\n")
  cat("![Progresividad por aval√∫o](", img_avaluo, "){width=90%}\n\n")
  cat("**Descripci√≥n:** Gr√°fico ladder que muestra la relaci√≥n entre rangos de aval√∫o (en UVT) y las tarifas correspondientes en ", params$nombre, ".\n\n")
  cat("**Interpretaci√≥n:** Una tendencia ascendente consistente indica progresividad, donde predios de mayor valor pagan tarifas proporcionalmente m√°s altas. Escalones horizontales indican tramos con tarifa fija.\n\n")
} else {
  # Generar gr√°fico din√°mico desde los datos
  cat("### An√°lisis de progresividad por aval√∫o (generado din√°micamente)\n\n")
  
  # Intentar cargar datos de transcripciones para an√°lisis detallado
  tryCatch({
    bd_transcripciones <- lee_rds("ds_estatutos/BD_Transcripciones.rds")
    
    # Filtrar datos del municipio
    datos_avaluo <- bd_transcripciones %>%
      filter(codigo_dane == params$cod_dane) %>%
      filter(!is.na(avaluo_desde) | !is.na(avaluo_hasta)) %>%
      filter(!is.na(tarifa))
    
    if (nrow(datos_avaluo) > 0) {
      library(ggplot2)
      
      # Preparar datos para gr√°fico
      datos_plot <- datos_avaluo %>%
        mutate(
          avaluo_medio = case_when(
            !is.na(avaluo_desde) & !is.na(avaluo_hasta) ~ (avaluo_desde + avaluo_hasta) / 2,
            !is.na(avaluo_desde) ~ avaluo_desde,
            !is.na(avaluo_hasta) ~ avaluo_hasta,
            TRUE ~ NA_real_
          ),
          avaluo_desde = ifelse(is.na(avaluo_desde), 0, avaluo_desde),
          avaluo_hasta = ifelse(is.na(avaluo_hasta), avaluo_medio * 2, avaluo_hasta)
        ) %>%
        filter(!is.na(avaluo_medio), !is.na(tarifa)) %>%
        arrange(avaluo_medio)
      
      if (nrow(datos_plot) >= 2) {
        # Crear gr√°fico ladder
        p_avaluo <- ggplot(datos_plot, aes(x = avaluo_medio, y = tarifa)) +
          geom_step(direction = "hv", color = "steelblue", size = 1.2) +
          geom_point(color = "darkblue", size = 2) +
          scale_x_continuous(
            trans = "log10",
            labels = scales::comma_format(scale = 1e-6, suffix = "M"),
            name = "Aval√∫o (UVT, escala logar√≠tmica)"
          ) +
          scale_y_continuous(
            labels = scales::number_format(suffix = "‚Ä∞"),
            name = "Tarifa predial (por mil)"
          ) +
          labs(
            title = paste("Progresividad por aval√∫o -", params$nombre),
            subtitle = "Relaci√≥n entre rangos de aval√∫o y tarifas prediales",
            caption = "Fuente: An√°lisis de estatutos tributarios"
          ) +
          theme_minimal() +
          theme(
            plot.title = element_text(size = 14, face = "bold"),
            plot.subtitle = element_text(size = 12),
            axis.title = element_text(size = 11),
            panel.grid.minor = element_blank()
          )
        
        print(p_avaluo)
        
        # An√°lisis de progresividad
        correlacion <- cor(datos_plot$avaluo_medio, datos_plot$tarifa, method = "spearman")
        n_intervalos <- nrow(datos_plot)
        incrementos_positivos <- sum(diff(datos_plot$tarifa[order(datos_plot$avaluo_medio)]) > 0)
        prop_progresiva <- round(incrementos_positivos / (n_intervalos - 1) * 100, 1)
        
        cat("\n**An√°lisis estad√≠stico:**\n")
        cat("- **N√∫mero de intervalos analizados:** ", n_intervalos, "\n")
        cat("- **Correlaci√≥n aval√∫o-tarifa (Spearman):** ", round(correlacion, 3), "\n")
        cat("- **Proporci√≥n de incrementos progresivos:** ", prop_progresiva, "%\n")
        
        if (correlacion > 0.7) {
          cat("- **Interpretaci√≥n:** Sistema altamente progresivo\n")
        } else if (correlacion > 0.3) {
          cat("- **Interpretaci√≥n:** Sistema moderadamente progresivo\n")
        } else if (correlacion > -0.3) {
          cat("- **Interpretaci√≥n:** Sistema con progresividad variable\n")
        } else {
          cat("- **Interpretaci√≥n:** Sistema con tendencia regresiva\n")
        }
        
      } else {
        cat("Datos insuficientes para generar an√°lisis de progresividad por aval√∫o.\n")
      }
      
    } else {
      cat("No se encontraron datos de aval√∫o para este municipio en los registros detallados.\n")
    }
    
  }, error = function(e) {
    cat("*No fue posible generar el an√°lisis de progresividad por aval√∫o para este municipio.*\n")
    cat("*Motivo: Datos de transcripci√≥n no disponibles o incompletos.*\n")
  })
}
```

## Progresividad por √°rea

```{r}
#| echo: false
#| results: asis
#| fig-width: 10
#| fig-height: 6

# Verificar si existe la imagen ladder de √°rea
img_area <- paste0("img_estatutos/", params$cod_dane, "_ladder_area.png")

if (file.exists(img_area)) {
  cat("El an√°lisis por √°rea eval√∫a la progresividad basada en la superficie construida:\n\n")
  cat("![Progresividad por √°rea](", img_area, "){width=90%}\n\n")
  cat("**Descripci√≥n:** Gr√°fico ladder que muestra la relaci√≥n entre rangos de √°rea construida (m¬≤) y las tarifas prediales en ", params$nombre, ".\n\n")
  cat("**Interpretaci√≥n:** Permite evaluar si el municipio penaliza o incentiva predios de mayor tama√±o. Una progresividad negativa podr√≠a indicar incentivos a la densificaci√≥n.\n\n")
} else {
  # Generar gr√°fico din√°mico desde los datos
  cat("### An√°lisis de progresividad por √°rea (generado din√°micamente)\n\n")
  
  tryCatch({
    bd_transcripciones <- lee_rds("ds_estatutos/BD_Transcripciones.rds")
    
    # Filtrar datos del municipio con informaci√≥n de √°rea
    datos_area <- bd_transcripciones %>%
      filter(codigo_dane == params$cod_dane) %>%
      filter(!is.na(area_desde) | !is.na(area_hasta)) %>%
      filter(!is.na(tarifa))
    
    if (nrow(datos_area) > 0) {
      library(ggplot2)
      
      # Preparar datos para gr√°fico
      datos_plot_area <- datos_area %>%
        mutate(
          area_media = case_when(
            !is.na(area_desde) & !is.na(area_hasta) ~ (area_desde + area_hasta) / 2,
            !is.na(area_desde) ~ area_desde,
            !is.na(area_hasta) ~ area_hasta,
            TRUE ~ NA_real_
          ),
          area_desde = ifelse(is.na(area_desde), 0, area_desde),
          area_hasta = ifelse(is.na(area_hasta), area_media * 2, area_hasta)
        ) %>%
        filter(!is.na(area_media), !is.na(tarifa), area_media > 0) %>%
        arrange(area_media)
      
      if (nrow(datos_plot_area) >= 2) {
        # Crear gr√°fico ladder para √°rea con mejoras visuales
        p_area <- ggplot(datos_plot_area, aes(x = area_media, y = tarifa)) +
          geom_step(direction = "hv", color = "darkgreen", size = 1.2, alpha = 0.8) +
          geom_point(color = "darkgreen", size = 2.5, alpha = 0.9) +
          geom_smooth(method = "loess", se = TRUE, color = "orange", alpha = 0.3, size = 0.8) +
          scale_x_continuous(
            trans = "log10",
            labels = scales::comma_format(suffix = " m¬≤"),
            name = "√Årea construida (m¬≤, escala logar√≠tmica)",
            breaks = scales::trans_breaks("log10", function(x) 10^x),
            minor_breaks = scales::trans_breaks("log10", function(x) 10^x, n = 10)
          ) +
          scale_y_continuous(
            labels = scales::number_format(suffix = "‚Ä∞"),
            name = "Tarifa predial (por mil)"
          ) +
          labs(
            title = paste("Progresividad por √°rea construida -", params$nombre),
            subtitle = "L√≠nea verde: escalones tarifarios | L√≠nea naranja: tendencia suavizada",
            caption = "Fuente: An√°lisis de estatutos tributarios ‚Ä¢ Mayor √°rea ‚Üí ¬øMayor o menor tarifa?"
          ) +
          theme_minimal() +
          theme(
            plot.title = element_text(size = 14, face = "bold", color = "darkgreen"),
            plot.subtitle = element_text(size = 11, color = "gray40"),
            plot.caption = element_text(size = 9, color = "gray50"),
            axis.title = element_text(size = 11),
            panel.grid.minor = element_blank(),
            panel.grid.major = element_line(color = "gray90", size = 0.5)
          )
        
        print(p_area)
        
        # An√°lisis de progresividad por √°rea mejorado
        correlacion_area <- cor(datos_plot_area$area_media, datos_plot_area$tarifa, method = "spearman")
        n_intervalos_area <- nrow(datos_plot_area)
        tarifa_ordenada <- datos_plot_area$tarifa[order(datos_plot_area$area_media)]
        incrementos_positivos_area <- sum(diff(tarifa_ordenada) > 0)
        decrementos_area <- sum(diff(tarifa_ordenada) < 0)
        prop_progresiva_area <- round(incrementos_positivos_area / (n_intervalos_area - 1) * 100, 1)
        
        # Calcular elasticidad √°rea-tarifa
        if (length(datos_plot_area$area_media) > 2) {
          modelo_area <- lm(log(tarifa) ~ log(area_media), data = datos_plot_area)
          elasticidad_area <- round(coef(modelo_area)[2], 3)
        } else {
          elasticidad_area <- NA
        }
        
        cat("\n**An√°lisis estad√≠stico avanzado:**\n")
        cat("- **N√∫mero de intervalos analizados:** ", n_intervalos_area, "\n")
        cat("- **Correlaci√≥n √°rea-tarifa (Spearman):** ", round(correlacion_area, 3), "\n")
        cat("- **Proporci√≥n de incrementos progresivos:** ", prop_progresiva_area, "%\n")
        cat("- **Incrementos vs. decrementos:** ", incrementos_positivos_area, " vs ", decrementos_area, "\n")
        if (!is.na(elasticidad_area)) {
          cat("- **Elasticidad √°rea-tarifa:** ", elasticidad_area, "\n")
        }
        
        if (correlacion_area > 0.3) {
          cat("- **Interpretaci√≥n:** Las tarifas tienden a aumentar con el √°rea (penalizaci√≥n a predios grandes)\n")
        } else if (correlacion_area < -0.3) {
          cat("- **Interpretaci√≥n:** Las tarifas tienden a disminuir con el √°rea (incentivo a predios grandes)\n")
        } else {
          cat("- **Interpretaci√≥n:** Las tarifas no presentan una relaci√≥n clara con el √°rea\n")
        }
        
        # Comparaci√≥n con aval√∫o (si disponible)
        datos_avaluo_comp <- bd_transcripciones %>%
          filter(codigo_dane == params$cod_dane) %>%
          filter(!is.na(avaluo_desde) | !is.na(avaluo_hasta)) %>%
          filter(!is.na(tarifa))
        
        if (nrow(datos_avaluo_comp) > 1) {
          datos_avaluo_comp <- datos_avaluo_comp %>%
            mutate(
              avaluo_medio = case_when(
                !is.na(avaluo_desde) & !is.na(avaluo_hasta) ~ (avaluo_desde + avaluo_hasta) / 2,
                !is.na(avaluo_desde) ~ avaluo_desde,
                !is.na(avaluo_hasta) ~ avaluo_hasta,
                TRUE ~ NA_real_
              )
            ) %>%
            filter(!is.na(avaluo_medio))
          
          if (nrow(datos_avaluo_comp) > 1) {
            correlacion_avaluo_comp <- cor(datos_avaluo_comp$avaluo_medio, datos_avaluo_comp$tarifa, method = "spearman")
            cat("- **Comparaci√≥n:** Correlaci√≥n aval√∫o-tarifa: ", round(correlacion_avaluo_comp, 3), 
                " vs √°rea-tarifa: ", round(correlacion_area, 3), "\n")
            
            if (abs(correlacion_area) > abs(correlacion_avaluo_comp)) {
              cat("- **Observaci√≥n:** El √°rea parece ser un criterio m√°s determinante que el aval√∫o\n")
            } else {
              cat("- **Observaci√≥n:** El aval√∫o parece ser un criterio m√°s determinante que el √°rea\n")
            }
          }
        }
        
      } else {
        cat("Datos insuficientes para generar an√°lisis de progresividad por √°rea.\n")
      }
      
    } else {
      cat("No se encontraron datos de √°rea para este municipio en los registros detallados.\n")
    }
    
  }, error = function(e) {
    cat("*No fue posible generar el an√°lisis de progresividad por √°rea para este municipio.*\n")
    cat("*Motivo: Datos de transcripci√≥n no disponibles o incompletos.*\n")
  })
}
```

# Contexto departamental

```{r}
#| echo: false
#| results: asis

cat("## Posici√≥n relativa en Antioquia\n\n")

# Generar estad√≠sticas comparativas
if (nrow(datos_municipio) > 0) {
  # Ranking por n√∫mero de reglas
  ranking_reglas <- bd_estatutos %>%
    count(codigo_dane, mpio, sort = TRUE) %>%
    mutate(ranking = row_number()) %>%
    filter(codigo_dane == params$cod_dane)
  
  if (nrow(ranking_reglas) > 0) {
    total_municipios <- bd_estatutos %>% distinct(codigo_dane) %>% nrow()
    cat("- **Ranking por complejidad normativa:** ", ranking_reglas$ranking, " de ", total_municipios, " municipios\n")
    cat("- **N√∫mero de reglas:** ", ranking_reglas$n, "\n")
    
    # Clasificaci√≥n
    if (ranking_reglas$ranking <= total_municipios * 0.25) {
      cat("- **Clasificaci√≥n:** Alta complejidad normativa (cuartil superior)\n")
    } else if (ranking_reglas$ranking <= total_municipios * 0.5) {
      cat("- **Clasificaci√≥n:** Complejidad normativa medio-alta\n")
    } else if (ranking_reglas$ranking <= total_municipios * 0.75) {
      cat("- **Clasificaci√≥n:** Complejidad normativa medio-baja\n")
    } else {
      cat("- **Clasificaci√≥n:** Baja complejidad normativa (cuartil inferior)\n")
    }
  }
}

cat("\n")

# Enlaces a visualizaciones generales si existen
img_generales <- c(
  "tipologia_agregada.png" = "Tipolog√≠as agregadas del departamento",
  "tipologia_todos.png" = "Complejidad normativa por municipio",
  "map_rules_count.png" = "Mapa de complejidad normativa",
  "tarifas_mapa_urbano.png" = "Mapa de tarifas urbanas",
  "tarifas_mapa_rural.png" = "Mapa de tarifas rurales"
)

cat("## Visualizaciones del contexto departamental\n\n")
for (i in seq_along(img_generales)) {
  img_path <- paste0("img_estatutos/", names(img_generales)[i])
  if (file.exists(img_path)) {
    cat("- [", img_generales[i], "](", img_path, ")\n")
  }
}
```

# Documentos de referencia

```{r}
#| echo: false
#| results: asis

cat("## Estatutos y documentos fuente\n\n")

if (nrow(freq_cat) > 0 && "enlace_pdf" %in% names(freq_cat)) {
  enlaces_disponibles <- freq_cat %>% 
    filter(enlace_pdf != "No disponible") %>%
    nrow()
  
  if (enlaces_disponibles > 0) {
    cat("Se han identificado ", enlaces_disponibles, " documentos fuente para este municipio. ")
    cat("Los enlaces de descarga est√°n disponibles en la tabla de estatutos al inicio de este documento.\n\n")
  } else {
    cat("Los documentos fuente est√°n en proceso de digitalizaci√≥n.\n\n")
  }
} else {
  cat("Los documentos fuente est√°n en proceso de digitalizaci√≥n.\n\n")
}

cat("## Metodolog√≠a del an√°lisis\n\n")
cat("Este an√°lisis forma parte del proyecto de sistematizaci√≥n de estatutos tributarios de Antioquia, que incluye:\n\n")
cat("1. **Transcripci√≥n normativa:** Conversi√≥n de estatutos f√≠sicos a formato digital estructurado\n")
cat("2. **Categorizaci√≥n:** Identificaci√≥n de criterios tarifarios (aval√∫o, √°rea, destino, estrato)\n")
cat("3. **An√°lisis de progresividad:** Evaluaci√≥n de la coherencia y equidad del sistema tarifario\n")
cat("4. **Comparaci√≥n intermunicipal:** Benchmarking con otros municipios del departamento\n\n")
cat("Para m√°s informaci√≥n sobre la metodolog√≠a completa, consulte el [an√°lisis departamental](estatuto_index.html).\n")
```

# Resumen visual integrado

```{r}
#| echo: false
#| results: asis
#| fig-width: 12
#| fig-height: 8

# Solo generar si hay datos de transcripciones
tryCatch({
  bd_transcripciones <- lee_rds("ds_estatutos/BD_Transcripciones.rds")
  datos_resumen <- bd_transcripciones %>%
    filter(codigo_dane == params$cod_dane)
  
  if (nrow(datos_resumen) > 0) {
    cat("## Dashboard de an√°lisis tributario\n\n")
    cat("Este resumen integra los principales hallazgos del an√°lisis tributario de ", params$nombre, ":\n\n")
    
    # Crear un layout de m√∫ltiples gr√°ficos si hay suficientes datos
    tryCatch({
      library(gridExtra)
      library(grid)
      use_grid <- TRUE
    }, error = function(e) {
      use_grid <- FALSE
    })
    
    plots_list <- list()
    
    # 1. Gr√°fico de tarifas mejorado con box plot y violin plot
    datos_tarifas_res <- datos_resumen %>% filter(!is.na(tarifa), tarifa > 0)
    if (nrow(datos_tarifas_res) > 1) {
      p1 <- ggplot(datos_tarifas_res, aes(x = "", y = tarifa)) +
        geom_violin(fill = "lightblue", alpha = 0.5, color = "blue") +
        geom_boxplot(fill = "lightblue", alpha = 0.8, width = 0.3, 
                     outlier.color = "red", outlier.size = 2) +
        geom_jitter(width = 0.1, alpha = 0.6, color = "darkblue", size = 1.5) +
        stat_summary(fun = mean, geom = "point", shape = 18, size = 4, color = "orange") +
        labs(
          title = "Distribuci√≥n de tarifas", 
          subtitle = paste("üîµ Datos | üì¶ Cuartiles | üü† Promedio | üî¥ Outliers"),
          y = "Tarifa (‚Ä∞)", 
          x = ""
        ) +
        theme_minimal() +
        theme(
          plot.title = element_text(size = 12, face = "bold"),
          plot.subtitle = element_text(size = 9, color = "gray50"),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()
        )
      plots_list <- append(plots_list, list(p1))
    }
    
    # 2. Gr√°fico de progresividad por aval√∫o si hay datos
    datos_avaluo_res <- datos_resumen %>%
      filter(!is.na(avaluo_desde) | !is.na(avaluo_hasta)) %>%
      filter(!is.na(tarifa)) %>%
      mutate(
        avaluo_medio = case_when(
          !is.na(avaluo_desde) & !is.na(avaluo_hasta) ~ (avaluo_desde + avaluo_hasta) / 2,
          !is.na(avaluo_desde) ~ avaluo_desde,
          !is.na(avaluo_hasta) ~ avaluo_hasta,
          TRUE ~ NA_real_
        )
      ) %>%
      filter(!is.na(avaluo_medio)) %>%
      arrange(avaluo_medio)
    
    if (nrow(datos_avaluo_res) >= 3) {
      # Calcular R¬≤ para mostrar calidad del ajuste
      modelo_temp <- lm(tarifa ~ log10(avaluo_medio), data = datos_avaluo_res)
      r_squared <- round(summary(modelo_temp)$r.squared, 3)
      
      p2 <- ggplot(datos_avaluo_res, aes(x = avaluo_medio, y = tarifa)) +
        geom_point(aes(size = avaluo_medio), color = "darkblue", alpha = 0.7) +
        geom_smooth(method = "lm", se = TRUE, color = "red", linetype = "dashed", alpha = 0.3) +
        geom_smooth(method = "loess", se = FALSE, color = "green", size = 1, alpha = 0.8) +
        scale_x_continuous(
          trans = "log10", 
          labels = scales::comma_format(scale = 1e-6, suffix = "M"),
          breaks = scales::trans_breaks("log10", function(x) 10^x, n = 4)
        ) +
        scale_size_continuous(guide = "none", range = c(1, 4)) +
        labs(
          title = "Progresividad por aval√∫o", 
          subtitle = paste("üî¥ Tendencia lineal (R¬≤=", r_squared, ") | üü¢ Tendencia suavizada"),
          x = "Aval√∫o (UVT)", 
          y = "Tarifa (‚Ä∞)"
        ) +
        theme_minimal() +
        theme(
          plot.title = element_text(size = 12, face = "bold"),
          plot.subtitle = element_text(size = 9, color = "gray50")
        )
      plots_list <- append(plots_list, list(p2))
    }
    
    # 3. Gr√°fico de criterios utilizados
    criterios_summary <- datos_resumen %>%
      summarise(
        Aval√∫o = sum(!is.na(avaluo_desde) | !is.na(avaluo_hasta)),
        √Årea = sum(!is.na(area_desde) | !is.na(area_hasta)),
        Destino = sum(!is.na(destino) & destino != "", na.rm = TRUE),
        Estrato = sum(!is.na(estrato) & estrato != "", na.rm = TRUE),
        Zona = sum(!is.na(zona) & zona != "", na.rm = TRUE)
      ) %>%
      tidyr::pivot_longer(everything(), names_to = "Criterio", values_to = "Frecuencia") %>%
      filter(Frecuencia > 0)
    
    if (nrow(criterios_summary) > 0) {
      p3 <- ggplot(criterios_summary, aes(x = reorder(Criterio, Frecuencia), y = Frecuencia)) +
        geom_col(fill = "darkgreen", alpha = 0.7) +
        coord_flip() +
        labs(title = "Criterios utilizados", x = "Criterio", y = "N√∫mero de reglas") +
        theme_minimal() +
        theme(plot.title = element_text(size = 12, face = "bold"))
      plots_list <- append(plots_list, list(p3))
    }
    
    # Mostrar gr√°ficos
    if (length(plots_list) > 0) {
      if (use_grid && length(plots_list) > 1) {
        # Usar grid si est√° disponible
        if (length(plots_list) == 2) {
          grid.arrange(grobs = plots_list, ncol = 2)
        } else if (length(plots_list) >= 3) {
          grid.arrange(grobs = plots_list, ncol = 2, nrow = 2)
        }
      } else {
        # Mostrar gr√°ficos individualmente
        for (i in seq_along(plots_list)) {
          print(plots_list[[i]])
        }
      }
      
      cat("\n**üéØ Interpretaci√≥n integral del dashboard:**\n")
      cat("Este dashboard proporciona una **visi√≥n 360¬∞ del sistema tributario** de ", params$nombre, ", integrando m√∫ltiples dimensiones anal√≠ticas:\n\n")
      
      # An√°lisis integrado m√°s sofisticado
      cat("**üìä Resumen ejecutivo:**\n")
      total_reglas <- nrow(datos_resumen)
      complejidad_score <- 0
      
      # Calcular score de complejidad
      if (nrow(criterios_summary) > 0) {
        complejidad_score <- complejidad_score + (nrow(criterios_summary) * 20)
      }
      if (nrow(datos_tarifas_res) > 0) {
        n_tarifas_unicas <- length(unique(datos_tarifas_res$tarifa))
        complejidad_score <- complejidad_score + min(n_tarifas_unicas * 5, 50)
        cv_tarifas <- sd(datos_tarifas_res$tarifa) / mean(datos_tarifas_res$tarifa)
        if (cv_tarifas > 0.5) complejidad_score <- complejidad_score + 30
      }
      
      cat("- **üìà Complejidad normativa:** ")
      if (complejidad_score >= 80) {
        cat("ALTA (score: ", complejidad_score, ") - Sistema muy sofisticado\n")
      } else if (complejidad_score >= 50) {
        cat("MODERADA (score: ", complejidad_score, ") - Sistema equilibrado\n")
      } else {
        cat("BAJA (score: ", complejidad_score, ") - Sistema simplificado\n")
      }
      
      cat("- **üî¢ Total de reglas analizadas:** ", total_reglas, "\n")
      
      if (nrow(datos_tarifas_res) > 0) {
        tarifa_promedio <- round(mean(datos_tarifas_res$tarifa), 2)
        tarifa_mediana <- round(median(datos_tarifas_res$tarifa), 2)
        dispersion <- round(sd(datos_tarifas_res$tarifa) / mean(datos_tarifas_res$tarifa), 3)
        
        cat("- **üí∞ Estructura tarifaria:**\n")
        cat("  - Tarifas √∫nicas: ", length(unique(datos_tarifas_res$tarifa)), "\n")
        cat("  - Tarifa t√≠pica: ", tarifa_mediana, "‚Ä∞ (mediana)\n")
        cat("  - Rango: ", min(datos_tarifas_res$tarifa), "‚Ä∞ - ", max(datos_tarifas_res$tarifa), "‚Ä∞\n")
        cat("  - Uniformidad: ", if(dispersion < 0.3) "Alta" else if(dispersion < 0.7) "Moderada" else "Baja", " (CV: ", dispersion, ")\n")
      }
      
      if (nrow(criterios_summary) > 0) {
        criterio_principal <- criterios_summary$Criterio[which.max(criterios_summary$Frecuencia)]
        cat("- **üéØ Criterios tarifarios activos:** ", nrow(criterios_summary), "\n")
        cat("  - Criterio principal: ", criterio_principal, " (", max(criterios_summary$Frecuencia), " reglas)\n")
      }
      
      # An√°lisis de progresividad si hay datos de aval√∫o
      if (nrow(datos_avaluo_res) >= 3) {
        cor_avaluo <- cor(datos_avaluo_res$avaluo_medio, datos_avaluo_res$tarifa, method = "spearman")
        cat("- **üìà Progresividad por aval√∫o:** ")
        if (cor_avaluo > 0.7) {
          cat("ALTA (r=", round(cor_avaluo, 2), ") - Sistema muy progresivo\n")
        } else if (cor_avaluo > 0.3) {
          cat("MODERADA (r=", round(cor_avaluo, 2), ") - Progresividad parcial\n")
        } else if (cor_avaluo > -0.3) {
          cat("VARIABLE (r=", round(cor_avaluo, 2), ") - Sin patr√≥n claro\n")
        } else {
          cat("REGRESIVA (r=", round(cor_avaluo, 2), ") - Tarifa decrece con aval√∫o\n")
        }
      }
      
      cat("\n**üîç Recomendaciones basadas en el an√°lisis:**\n")
      if (complejidad_score >= 80) {
        cat("- Considerar **simplificaci√≥n** del esquema tarifario\n")
        cat("- Implementar **herramientas digitales** para facilitar aplicaci√≥n\n")
      } else if (complejidad_score < 30) {
        cat("- Evaluar si el esquema actual **captura adecuadamente** la capacidad contributiva\n")
        cat("- Considerar mayor **diferenciaci√≥n** tarifaria si es viable\n")
      } else {
        cat("- Mantener **equilibrio actual** entre simplicidad y equidad\n")
        cat("- Realizar **revisiones peri√≥dicas** del esquema\n")
      }
      
      if (nrow(datos_tarifas_res) > 0 && sd(datos_tarifas_res$tarifa) / mean(datos_tarifas_res$tarifa) > 1) {
        cat("- **Alta dispersi√≥n** detectada: revisar coherencia entre tarifas\n")
      }
    }
    
  } else {
    cat("No hay suficientes datos para generar el dashboard visual.\n")
  }
  
}, error = function(e) {
  cat("*Dashboard visual no disponible para este municipio.*\n")
})
```

# Estad√≠sticas avanzadas del municipio

```{r}
#| echo: false
#| results: asis

if (nrow(datos_municipio) > 0) {
  cat("## An√°lisis temporal de la normativa\n\n")
  
  # An√°lisis temporal si hay datos de a√±o
  if ("anio" %in% names(datos_municipio) && any(!is.na(datos_municipio$anio))) {
    # Evoluci√≥n temporal
    evolucion <- datos_municipio %>%
      filter(!is.na(anio)) %>%
      count(anio, sort = TRUE)
    
    if (nrow(evolucion) > 1) {
      cat("### Evoluci√≥n de la actividad normativa\n\n")
      anos_activos <- evolucion$anio
      cat("- **A√±os con mayor actividad normativa:** ", paste(head(anos_activos, 3), collapse = ", "), "\n")
      cat("- **Per√≠odo de mayor estabilidad:** ")
      
      # Buscar per√≠odos sin cambios
      gaps <- diff(anos_activos)
      if (any(gaps > 1)) {
        cat("Se observan per√≠odos de estabilidad normativa entre algunos a√±os\n")
      } else {
        cat("Actividad normativa continua en el per√≠odo analizado\n")
      }
      
      # Tabla de evoluci√≥n
      cat("\n")
      kable(evolucion, 
            col.names = c("A√±o", "N√∫mero de registros"),
            caption = "Evoluci√≥n temporal de la normativa tributaria")
      cat("\n")
    }
  }
  
  # An√°lisis de tipos de normativa
  if ("tipo" %in% names(datos_municipio) && any(!is.na(datos_municipio$tipo))) {
    cat("## Tipolog√≠a normativa\n\n")
    
    tipos_freq <- datos_municipio %>%
      filter(!is.na(tipo)) %>%
      count(tipo, sort = TRUE)
    
    if (nrow(tipos_freq) > 0) {
      cat("### Distribuci√≥n por tipo de normativa\n\n")
      kable(tipos_freq, 
            col.names = c("Tipo de normativa", "Frecuencia"),
            caption = "Tipos de instrumentos normativos utilizados")
      cat("\n")
      
      tipo_principal <- tipos_freq$tipo[1]
      freq_principal <- tipos_freq$n[1]
      porcentaje_principal <- round((freq_principal / nrow(datos_municipio)) * 100, 1)
      
      cat("- **Instrumento normativo predominante:** ", tipo_principal, 
          " (", freq_principal, " registros, ", porcentaje_principal, "%)\n")
    }
  }
  
  # Comparaci√≥n con promedios departamentales
  cat("## Comparaci√≥n departamental\n\n")
  
  # Estad√≠sticas departamentales
  stats_dpto <- bd_estatutos %>%
    group_by(codigo_dane) %>%
    summarise(
      total_registros = n(),
      .groups = 'drop'
    )
  
  promedio_dpto <- mean(stats_dpto$total_registros, na.rm = TRUE)
  mediana_dpto <- median(stats_dpto$total_registros, na.rm = TRUE)
  
  registros_municipio <- nrow(datos_municipio)
  
  cat("- **Registros de este municipio:** ", registros_municipio, "\n")
  cat("- **Promedio departamental:** ", round(promedio_dpto, 1), "\n")
  cat("- **Mediana departamental:** ", round(mediana_dpto, 1), "\n")
  
  # Clasificaci√≥n relativa
  if (registros_municipio > promedio_dpto) {
    cat("- **Clasificaci√≥n:** Por encima del promedio departamental (", 
        round((registros_municipio - promedio_dpto) / promedio_dpto * 100, 1), 
        "% m√°s registros)\n")
  } else {
    cat("- **Clasificaci√≥n:** Por debajo del promedio departamental (", 
        round((promedio_dpto - registros_municipio) / promedio_dpto * 100, 1), 
        "% menos registros)\n")
  }
  
  # Percentil
  percentil <- round(sum(stats_dpto$total_registros <= registros_municipio) / nrow(stats_dpto) * 100, 1)
  cat("- **Percentil departamental:** ", percentil, "% (", 
      round(100 - percentil, 1), "% de municipios tienen m√°s registros)\n")

} else {
  cat("No hay datos suficientes para generar estad√≠sticas avanzadas.\n")
}
```

# Recomendaciones espec√≠ficas

```{r}
#| echo: false
#| results: asis

if (nrow(datos_municipio) > 0) {
  cat("## Recomendaciones de pol√≠tica tributaria\n\n")
  
  # Generar recomendaciones basadas en las caracter√≠sticas del municipio
  registros_municipio <- nrow(datos_municipio)
  
  # Obtener estad√≠sticas para comparaci√≥n
  stats_dpto <- bd_estatutos %>%
    group_by(codigo_dane) %>%
    summarise(total_registros = n(), .groups = 'drop')
  
  promedio_dpto <- mean(stats_dpto$total_registros, na.rm = TRUE)
  cuartil_superior <- quantile(stats_dpto$total_registros, 0.75, na.rm = TRUE)
  cuartil_inferior <- quantile(stats_dpto$total_registros, 0.25, na.rm = TRUE)
  
  cat("Bas√°ndose en el an√°lisis comparativo, se sugieren las siguientes recomendaciones:\n\n")
  
  if (registros_municipio > cuartil_superior) {
    cat("### Simplificaci√≥n normativa (Alta complejidad)\n\n")
    cat("- **Revisi√≥n integral:** Considerar la consolidaci√≥n de reglas similares para reducir complejidad administrativa\n")
    cat("- **Digitalizaci√≥n:** Implementar herramientas digitales para facilitar el c√°lculo y aplicaci√≥n de tarifas\n")
    cat("- **Capacitaci√≥n:** Fortalecer las competencias t√©cnicas del personal tributario\n")
    cat("- **Comunicaci√≥n:** Desarrollar material did√°ctico para facilitar el entendimiento ciudadano\n\n")
  } else if (registros_municipio < cuartil_inferior) {
    cat("### Optimizaci√≥n del potencial tributario (Baja complejidad)\n\n")
    cat("- **An√°lisis de brechas:** Evaluar si la simplicidad actual captura adecuadamente la capacidad contributiva\n")
    cat("- **Benchmarking:** Considerar mejores pr√°cticas de municipios similares\n")
    cat("- **Progresividad:** Evaluar la implementaci√≥n de esquemas m√°s progresivos si es t√©cnicamente viable\n")
    cat("- **Actualizaci√≥n:** Revisar la vigencia y pertinencia de las tarifas actuales\n\n")
  } else {
    cat("### Optimizaci√≥n del esquema actual (Complejidad media)\n\n")
    cat("- **Eficiencia:** Evaluar la efectividad del esquema actual en t√©rminos de recaudo y equidad\n")
    cat("- **Actualizaci√≥n peri√≥dica:** Establecer cronogramas regulares de revisi√≥n normativa\n")
    cat("- **Monitoreo:** Implementar indicadores de seguimiento a la aplicaci√≥n de tarifas\n")
    cat("- **Participaci√≥n:** Involucrar a la ciudadan√≠a en procesos de actualizaci√≥n normativa\n\n")
  }
  
  cat("### Recomendaciones generales\n\n")
  cat("- **Transparencia:** Publicar de manera clara y accesible todas las tarifas vigentes\n")
  cat("- **Tecnolog√≠a:** Aprovechar herramientas digitales para mejorar la gesti√≥n tributaria\n")
  cat("- **Equidad:** Evaluar peri√≥dicamente el impacto distributivo del sistema tarifario\n")
  cat("- **Coordinaci√≥n:** Mantener coherencia con las pol√≠ticas tributarias departamentales\n\n")
  
} else {
  cat("Para generar recomendaciones espec√≠ficas se requieren datos adicionales del municipio.\n")
}
```